name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      id: checkout
      uses: actions/checkout@v2

    - name: Deploy to server
      id: deploy
      uses: appleboy/ssh-action@master
      with: 
          host: ${{secrets.SERVER_HOST}}
          username: ${{secrets.SERVER_USERNAME}}
          password: ${{secrets.SERVER_PASSWORD}}
          port: 22
          script: | 
            # Переход в директорию проекта
            cd Mini-Bank-Web/ || { echo "Failed to change directory to /Mini-bank-web"; exit 1; }
            
            # Создание файла .env на удаленном сервере
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
            echo "DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}" >> .env
            echo "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" >> .env

            # Переход в директорию проекта и выполнение команд
            sudo docker-compose down || { echo "Failed to stop and remove containers"; exit 1; }
            git pull
            mvn clean install || { echo "Failed to run mvn clean install"; exit 1; }
            sudo docker-compose build || { echo "Failed to build containers"; exit 1; }
            sudo docker-compose up || { echo "Failed to start containers"; exit 1; }
            
